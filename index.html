<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>MIDI 6 Sampler</title>

<style>
body {
  background: #111;
  color: #eee;
  font-family: system-ui, sans-serif;
  padding: 20px;
}

button {
  font-size: 16px;
  padding: 10px 16px;
  margin-bottom: 16px;
}

#status {
  font-size: 14px;
  margin-bottom: 20px;
  white-space: pre-line;
}

.pads {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  max-width: 360px;
}

.pad {
  background: #222;
  border: 2px solid #444;
  height: 100px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  user-select: none;
  transition: background 0.05s, border-color 0.05s;
}

.pad.active {
  background: #0af;
  border-color: #9df;
  color: #000;
}
</style>
</head>

<body>

<h1>MIDI Sampler (Practice)</h1>

<button id="startButton">üéπ MIDI / Audio ÊúâÂäπÂåñ</button>
<div id="status">Êú™Êé•Á∂ö</div>

<div class="pads" id="pads"></div>

<script>
/* ===== Ë®≠ÂÆö ===== */
const SAMPLE_CONFIG = {
  36: { name: "Timpani",      url: "https://cdn.jsdelivr.net/gh/mdn/webaudio-examples/audio-basics/techno.wav", mode: "oneshot" },
  38: { name: "Low Strings",  url: "https://cdn.jsdelivr.net/gh/mdn/webaudio-examples/audio-basics/techno.wav", mode: "gate" },
  40: { name: "Brass Hit",    url: "https://cdn.jsdelivr.net/gh/mdn/webaudio-examples/audio-basics/techno.wav", mode: "oneshot" },
  41: { name: "String Pad",   url: "https://cdn.jsdelivr.net/gh/mdn/webaudio-examples/audio-basics/techno.wav", mode: "gate" },
  43: { name: "FX Perc",      url: "https://cdn.jsdelivr.net/gh/mdn/webaudio-examples/audio-basics/techno.wav", mode: "oneshot" },
  45: { name: "Noise Bed",    url: "https://cdn.jsdelivr.net/gh/mdn/webaudio-examples/audio-basics/techno.wav", mode: "gate" }
};

/* ===== Audio ===== */
const audioContext = new AudioContext();
const buffers = {};
const activeSources = {};

/* ===== UI ===== */
const status = document.getElementById("status");
const padContainer = document.getElementById("pads");
const pads = {};

/* UIÁîüÊàê */
for (const note in SAMPLE_CONFIG) {
  const div = document.createElement("div");
  div.className = "pad";
  div.innerHTML = `<strong>${SAMPLE_CONFIG[note].name}</strong><div>Note ${note}</div>`;
  padContainer.appendChild(div);
  pads[note] = div;
}

/* ===== „Çµ„É≥„Éó„É´Ë™≠„ÅøËæº„Åø ===== */
async function loadSamples() {
  for (const note in SAMPLE_CONFIG) {
    const res = await fetch(SAMPLE_CONFIG[note].url);
    const arrayBuffer = await res.arrayBuffer();
    buffers[note] = await audioContext.decodeAudioData(arrayBuffer);
    console.log("loaded:", note);
  }
}

/* ===== Note ON ===== */
async function noteOn(note, velocity) {
  if (audioContext.state !== "running") {
    await audioContext.resume();
    console.log("AudioContext resumed");
  }

  const config = SAMPLE_CONFIG[note];
  if (!config || !buffers[note]) return;

  const source = audioContext.createBufferSource();
  const gain = audioContext.createGain();

  gain.gain.value = velocity / 127;
  source.buffer = buffers[note];
  source.connect(gain).connect(audioContext.destination);
  source.start();

  pads[note]?.classList.add("active");

  if (config.mode === "gate") {
    activeSources[note] = source;
  } else {
    source.onended = () => pads[note]?.classList.remove("active");
  }
}

/* ===== Note OFF ===== */
function noteOff(note) {
  if (activeSources[note]) {
    activeSources[note].stop();
    delete activeSources[note];
    pads[note]?.classList.remove("active");
  }
}

/* ===== MIDI ===== */
function onMIDIMessage(e) {
  const [statusByte, note, velocity] = e.data;
  const cmd = statusByte & 0xf0;

  if (cmd === 0x90 && velocity > 0) {
    noteOn(note, velocity);
  } else if (cmd === 0x80 || (cmd === 0x90 && velocity === 0)) {
    noteOff(note);
  }
}

/* ===== ÂàùÊúüÂåñ ===== */
document.getElementById("startButton").onclick = async () => {
  await audioContext.resume();

  status.textContent = "Èü≥Ê∫êË™≠„ÅøËæº„Åø‰∏≠...";
  await loadSamples();

  const midi = await navigator.requestMIDIAccess();
  const inputs = [...midi.inputs.values()];
  inputs.forEach(i => i.onmidimessage = onMIDIMessage);

  status.textContent = "Ê∫ñÂÇôÂÆå‰∫Ü\nMIDI:\n" + inputs.map(i => i.name).join("\n");
};
</script>

</body>
</html>
