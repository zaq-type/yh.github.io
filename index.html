<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>MIDI Sampler - Debug Mode</title>
    <style>
        body {
            background: #111;
            color: #eee;
            font-family: sans-serif;
            text-align: center;
            padding: 20px;
        }

        button {
            font-size: 18px;
            padding: 15px 30px;
            cursor: pointer;
            background: #0af;
            border: none;
            border-radius: 5px;
            color: #000;
            font-weight: bold;
        }

        button:disabled {
            background: #444;
            color: #888;
        }

        #status {
            margin: 20px;
            padding: 10px;
            border: 1px dashed #444;
            min-height: 50px;
            background: #222;
        }

        #midi-monitor {
            color: #0f0;
            font-family: monospace;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .pads {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-width: 450px;
            margin: 0 auto;
        }

        .pad {
            background: #333;
            border: 3px solid #555;
            height: 120px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: 0.1s;
        }

        .pad.active {
            background: #fff;
            border-color: #0af;
            color: #000;
            transform: scale(0.95);
            box-shadow: 0 0 20px #0af;
        }

        .note-num {
            font-size: 0.8rem;
            opacity: 0.6;
        }
    </style>
</head>

<body>

    <h1>MIDI Sampler (Debug Mode)</h1>

    <button id="startButton">1. サウンドとMIDIを有効化</button>

    <div id="status">ボタンを押してください</div>

    <div id="midi-monitor">MIDI信号を待機中... (鍵盤を弾いてください)</div>

    <div class="pads" id="pads"></div>

    <script>
        let audioContext;
        const buffers = {};
        const activeSources = {};
        const statusEl = document.getElementById("status");
        const monitorEl = document.getElementById("midi-monitor");

        // サンプルの設定
        const SAMPLE_CONFIG = {
            36: { name: "C1 (Timpani)", url: "https://raw.githubusercontent.com/zaq-type/yh.github.io/main/byakkoya01.wav", mode: "oneshot" },
            38: { name: "D1 (Strings)", url: "https://raw.githubusercontent.com/zaq-type/yh.github.io/main/byakkoya02.wav", mode: "oneshot" },
            40: { name: "E1 (Brass)", url: "https://raw.githubusercontent.com/zaq-type/yh.github.io/main/byakkoya03.wav", mode: "oneshot" },
            41: { name: "F1 (Pad)", url: "https://raw.githubusercontent.com/zaq-type/yh.github.io/main/byakkoya04.wav", mode: "oneshot" },
            43: { name: "G1 (FX)", url: "https://raw.githubusercontent.com/zaq-type/yh.github.io/main/byakkoya05.wav", mode: "oneshot" },
            45: { name: "A1 (Noise)", url: "https://raw.githubusercontent.com/zaq-type/yh.github.io/main/byakkoya06.wav", mode: "oneshot" }
        };

        // UIの生成
        const padsUI = {};
        for (const note in SAMPLE_CONFIG) {
            const div = document.createElement("div");
            div.className = "pad";
            div.id = "pad-" + note;
            div.innerHTML = `<strong>${SAMPLE_CONFIG[note].name}</strong><div class="note-num">Note: ${note}</div>`;
            document.getElementById("pads").appendChild(div);
            padsUI[note] = div;
        }

        // 音源の読み込み
        async function loadSamples() {
            for (const note in SAMPLE_CONFIG) {
                try {
                    const res = await fetch(SAMPLE_CONFIG[note].url);
                    const arrayBuffer = await res.arrayBuffer();
                    buffers[note] = await audioContext.decodeAudioData(arrayBuffer);
                } catch (e) {
                    console.error("Load error:", note, e);
                }
            }
        }

        // 再生
        function playSound(note, velocity) {
            if (!buffers[note]) return;

            // 既存の音を停止（gate/連打用）
            stopSound(note);

            const source = audioContext.createBufferSource();
            const gain = audioContext.createGain();
            source.buffer = buffers[note];
            gain.gain.value = velocity / 127;

            source.connect(gain).connect(audioContext.destination);
            source.start(0);

            activeSources[note] = { source, gain };
            padsUI[note].classList.add("active");

            source.onended = () => {
                if (activeSources[note]?.source === source) {
                    padsUI[note].classList.remove("active");
                }
            };
        }

        // 停止
        function stopSound(note) {
            if (activeSources[note]) {
                const { source, gain } = activeSources[note];
                gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
                source.stop(audioContext.currentTime + 0.1);
                delete activeSources[note];
                padsUI[note].classList.remove("active");
            }
        }

        // MIDIメッセージ受信
        function handleMidi(e) {
            const [status, note, velocity] = e.data;
            const cmd = status & 0xf0;

            // モニター表示を更新（ここが重要！）
            monitorEl.textContent = `受信中: CMD=${cmd.toString(16)}, NOTE=${note}, VEL=${velocity}`;

            if (cmd === 0x90 && velocity > 0) {
                if (SAMPLE_CONFIG[note]) {
                    playSound(note, velocity);
                } else {
                    monitorEl.style.color = "orange";
                    monitorEl.textContent += " (未設定のノートです)";
                }
            } else if (cmd === 0x80 || (cmd === 0x90 && velocity === 0)) {
                if (SAMPLE_CONFIG[note] && SAMPLE_CONFIG[note].mode === "gate") {
                    stopSound(note);
                }
            }
        }

        // 開始ボタン
        document.getElementById("startButton").onclick = async function () {
            this.disabled = true;
            statusEl.textContent = "初期化中...";

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                await loadSamples();

                const midi = await navigator.requestMIDIAccess();
                const inputs = [...midi.inputs.values()];

                if (inputs.length === 0) {
                    statusEl.textContent = "MIDIデバイスが見つかりません。接続を確認して再読み込みしてください。";
                    this.disabled = false;
                } else {
                    inputs.forEach(input => input.onmidimessage = handleMidi);
                    statusEl.textContent = "接続済み: " + inputs.map(i => i.name).join(", ");
                    monitorEl.textContent = "鍵盤またはパッドを叩いてください...";
                }
            } catch (err) {
                statusEl.textContent = "エラー: " + err;
                this.disabled = false;
            }
        };
    </script>
</body>

</html>
