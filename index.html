<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>MIDI Minimal Sampler</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      padding: 20px;
    }
    button {
      font-size: 16px;
      padding: 10px 16px;
      margin-bottom: 16px;
    }
    .log {
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      background: #222;
      padding: 10px;
    }
  </style>
</head>
<body>

  <h1>MIDI Minimal Sampler</h1>

  <button id="startButton">ğŸ¹ MIDIã‚’æœ‰åŠ¹åŒ–</button>

  <div class="log" id="log">
    MIDIæœªæ¥ç¶š
  </div>

<script>
let audioContext;
let sampleBuffer = null;

// ===== ãƒ­ã‚°è¡¨ç¤º =====
const log = (msg) => {
  document.getElementById("log").textContent = msg;
};

// ===== ã‚µãƒ³ãƒ—ãƒ«éŸ³æºï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰=====
// è‡ªåˆ†ã§ wav ã‚’ç½®ãå ´åˆã¯ URL ã‚’å·®ã—æ›¿ãˆã‚‹
const SAMPLE_URL =
  "https://cdn.jsdelivr.net/gh/mdn/webaudio-examples/audio-basics/techno.wav";

// ===== ã‚µãƒ³ãƒ—ãƒ«èª­ã¿è¾¼ã¿ =====
async function loadSample() {
  const res = await fetch(SAMPLE_URL);
  const arrayBuffer = await res.arrayBuffer();
  sampleBuffer = await audioContext.decodeAudioData(arrayBuffer);
}

// ===== éŸ³ã‚’é³´ã‚‰ã™ =====
function playSample(velocity = 100) {
  if (!sampleBuffer) return;

  const source = audioContext.createBufferSource();
  const gain = audioContext.createGain();

  gain.gain.value = velocity / 127;

  source.buffer = sampleBuffer;
  source.connect(gain).connect(audioContext.destination);
  source.start();
}

// ===== MIDIå‡¦ç† =====
function onMIDIMessage(event) {
  const [status, note, velocity] = event.data;

  const isNoteOn = status === 144 && velocity > 0;

  if (isNoteOn) {
    log(`Note ON : ${note}  Velocity : ${velocity}`);
    playSample(velocity);
  }
}

// ===== MIDIåˆæœŸåŒ– =====
async function initMIDI() {
  if (!navigator.requestMIDIAccess) {
    log("Web MIDI API éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™");
    return;
  }

  const midi = await navigator.requestMIDIAccess();
  const inputs = [...midi.inputs.values()];

  if (inputs.length === 0) {
    log("MIDIãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }

  inputs.forEach(input => {
    input.onmidimessage = onMIDIMessage;
  });

  log("MIDIæ¥ç¶šå®Œäº†:\n" + inputs.map(i => i.name).join("\n"));
}

// ===== ãƒœã‚¿ãƒ³æ“ä½œï¼ˆé‡è¦ï¼‰=====
document.getElementById("startButton").onclick = async () => {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();

  // â˜…ã“ã‚Œã‚’å¿…ãšå…¥ã‚Œã‚‹
  await audioContext.resume();
  
  await loadSample();
  await initMIDI();

  log("æº–å‚™å®Œäº†ã€‚ãƒãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„");
};
</script>

</body>
</html>
