<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>MIDI Minimal Sampler</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      padding: 20px;
    }
    button {
      font-size: 16px;
      padding: 10px 16px;
      margin-bottom: 16px;
    }
    .log {
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      background: #222;
      padding: 10px;
    }
  </style>
</head>
<body>

  <h1>MIDI Minimal Sampler</h1>

  <button id="startButton">ğŸ¹ MIDIã‚’æœ‰åŠ¹åŒ–</button>

  <div class="log" id="log">
    MIDIæœªæ¥ç¶š
  </div>

<script>
let audioContext;
let sampleBuffer = null;

const log = msg => {
  document.getElementById("log").textContent = msg;
};

const SAMPLE_URL =
  "https://cdn.jsdelivr.net/gh/mdn/webaudio-examples/audio-basics/techno.wav";

async function loadSample() {
  try {
    const res = await fetch(SAMPLE_URL);
    const arrayBuffer = await res.arrayBuffer();
    sampleBuffer = await audioContext.decodeAudioData(arrayBuffer);
    log("éŸ³æºèª­ã¿è¾¼ã¿å®Œäº†");
  } catch (e) {
    log("éŸ³æºèª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆMIDIã¯ä½¿ãˆã¾ã™ï¼‰");
    console.error(e);
  }
}

function playSample(velocity = 100) {
  if (!sampleBuffer) return;

  const src = audioContext.createBufferSource();
  const gain = audioContext.createGain();

  gain.gain.value = velocity / 127;
  src.buffer = sampleBuffer;
  src.connect(gain).connect(audioContext.destination);
  src.start();
}

function onMIDIMessage(e) {
  const [status, note, vel] = e.data;
  if (status === 144 && vel > 0) {
    log(`Note ON ${note} vel ${vel}`);
    playSample(vel);
  }
}

async function initMIDI() {
  const midi = await navigator.requestMIDIAccess();
  const inputs = [...midi.inputs.values()];

  if (inputs.length === 0) {
    log("MIDIãƒ‡ãƒã‚¤ã‚¹ãªã—");
    return;
  }

  inputs.forEach(i => i.onmidimessage = onMIDIMessage);
  log("MIDIæ¥ç¶šå®Œäº†");
}

document.getElementById("startButton").onclick = async () => {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  await audioContext.resume();

  // â˜…é †ç•ªãŒé‡è¦
  await initMIDI();     // å…ˆã«MIDI
  await loadSample();   // éŸ³ã¯å¾Œï¼ˆå¤±æ•—ã—ã¦ã‚‚OKï¼‰

  log("æº–å‚™å®Œäº†ã€‚ãƒãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„");
};
</script>

</body>
</html>
